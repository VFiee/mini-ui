{"version":3,"file":"index.js","sources":["../../../packages/components/authorize/index.tsx"],"sourcesContent":["import React from \"react\";\nimport { login } from \"@tarojs/taro\";\nimport { Button } from \"@tarojs/components\";\nimport { isFunction, isPromise, ensureAuthScope } from \"utils\";\nimport { AuthorizeProps, AuthorizeService, PromiseFn, Service } from \"types\";\n\nconst SUCCESS_MSG = {\n  getPhoneNumber: \"getPhoneNumber:ok\",\n  getUserInfo: \"getUserInfo:ok\",\n};\n\nasync function getService(\n  service: AuthorizeService,\n  param: object = {}\n): Promise<any> {\n  if (service === void 0) {\n    throw `service is undefined!`;\n  }\n  if (isPromise(service)) {\n    return (service as PromiseFn)(param);\n  }\n  let { params, fn, needMiniCode, codeKey } = service as Service;\n  params = {\n    ...params,\n    ...param,\n  };\n  if (needMiniCode) {\n    params[codeKey || \"code\"] = await login();\n  }\n  return fn(params);\n}\n\nasync function onGetPhoneNumber(eve: any) {\n  const { errMsg, ...rest } = eve.detail;\n  if (errMsg !== SUCCESS_MSG.getPhoneNumber) {\n    return;\n  }\n  try {\n    let userinfo = await getService(this.service, rest);\n    // dispatch({type:\"userinfo/update\",payload:{userinfo}});\n    onSuccess.bind(this, userinfo, eve)();\n  } catch (error) {}\n}\n\nasync function onGetUserInfo(eve: any) {\n  const { errMsg, ...rest } = eve.detail;\n  if (errMsg !== SUCCESS_MSG.getUserInfo) {\n    return;\n  }\n  try {\n    let userinfo = await getService(this.service, rest);\n    // dispatch({type:\"userinfo/update\",payload:{userinfo}});\n    onSuccess.bind(this, userinfo, eve)();\n  } catch (error) {}\n}\n\nfunction authorizeScope(eve: any) {\n  ensureAuthScope(this.authScope)\n    .then(() => {\n      this.onAuthorize && this.onAuthorize(eve);\n    })\n    .catch(() => {\n      console.log(`未授权:${this.authScope}`);\n    });\n}\n\nfunction onSuccess(...args: any) {\n  isFunction(this.onAuthorize) && this.onAuthorize(...args);\n}\n\nconst Authorize = (props: AuthorizeProps) => {\n  const { authorize, onAuthorize, className = \"\", openType, ...rest } = props;\n  function onClick(eve: any) {\n    if (!openType) return;\n    const openTypeFns = {\n      contact: onSuccess.bind(props),\n      launchApp: onSuccess.bind(props),\n      scope: authorizeScope.bind(props),\n      getUserInfo: onGetUserInfo.bind(props),\n      getPhoneNumber: onGetPhoneNumber.bind(props),\n    };\n\n    if (!isFunction(openTypeFns[openType])) return;\n    openTypeFns[openType](eve);\n  }\n  return (\n    <React.Fragment>\n      {!authorize ? (\n        // @ts-ignore\n        <Button\n          {...rest}\n          openType={openType}\n          onClick={onClick}\n          onContact={onClick}\n          onLaunchapp={onClick}\n          onGetUserInfo={onClick}\n          onGetPhoneNumber={onClick}\n          className={`__authorize__ ${className}`}\n        >\n          {props?.children}\n        </Button>\n      ) : (\n        // @ts-ignore\n        <Button\n          {...rest}\n          openType=\"\"\n          onClick={(eve) => onAuthorize && onAuthorize(eve)}\n          className={`__authorize__ ${className}`}\n        >\n          {props?.children}\n        </Button>\n      )}\n    </React.Fragment>\n  );\n};\n\nAuthorize.options = {\n  addGlobalClass: true,\n};\n\nexport default Authorize;\n"],"names":[],"mappings":"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"}