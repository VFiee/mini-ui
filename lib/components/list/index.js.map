{"version":3,"file":"index.js","sources":["../../../packages/components/list/index.tsx"],"sourcesContent":["import React, {\n  isValidElement,\n  useMemo,\n  useState,\n  useCallback,\n  useRef,\n} from \"react\";\nimport { ScrollView, View, Slot } from \"@tarojs/components\";\nimport Loading from \"components/loading\";\nimport { isEmpty, isFunction, isReactComponentType } from \"utils\";\nimport { useMount, useUpdate } from \"hooks\";\nimport { ListProps, PullingStatus } from \"types\";\n\nconst pullStatusText = [\n  \"\",\n  \"下拉刷新\",\n  \"松开手刷新\",\n  \"正在加载...\",\n  \"加载成功\",\n  \"加载失败\",\n];\n\nconst defaultProps = {\n  scrollY: true,\n  hasMore: true,\n  firstTriggered: false,\n  refresherEnabled: true,\n  lowerThreshold: 80,\n  loadingText: \"加载中...\",\n  errorText: \"请求失败,点击重新加载\",\n  refresherDefaultStyle: \"none\",\n  refresherThreshold: 50,\n  refresherBackground: \"#00ab84\",\n  refresherStayTime: 700,\n};\n\nconst List = (props: ListProps) => {\n  const {\n    data,\n    error,\n    errorClass,\n    errorStyle,\n    errorText,\n    loading,\n    loadingText,\n    loadingClass,\n    loadingStyle,\n    hasMore,\n    className,\n    onRefresh,\n    onReachBottom,\n    onRefreshCancel,\n    firstTriggered,\n    onRefresherRefresh,\n    onRefresherAbort,\n    onRefresherRestore,\n    ListComponent,\n    refresherThreshold,\n    refresherStayTime,\n    refresherDefaultStyle,\n    refresherClassName,\n    refresherStyle,\n    ...restProps\n  } = {\n    ...defaultProps,\n    ...props,\n  };\n  const update = useUpdate();\n  const refresherRef = useRef<PullingStatus>(PullingStatus.static);\n  const setRefresherStatus = useCallback(\n    (status: PullingStatus) => {\n      refresherRef.current = status;\n      update();\n    },\n    [update]\n  );\n  const [bottomState, setBottomState] = useState({\n    loading: false,\n    error: false,\n  });\n  useMount(() => {\n    if (firstTriggered) {\n      setTimeout(() => {\n        setRefresherStatus(PullingStatus.loading);\n      }, 0);\n    }\n  });\n\n  // 下拉动作\n  const _onRefresherPulling = useCallback(\n    (eve) => {\n      if (refresherRef.current < PullingStatus.loading) {\n        const { dy } = eve.detail;\n        setRefresherStatus(\n          dy >= refresherThreshold\n            ? PullingStatus.overPulling\n            : PullingStatus.pulling\n        );\n      }\n    },\n    [refresherThreshold, setRefresherStatus]\n  );\n\n  // 触发下拉刷新\n  const _onRefresherRefresh = useCallback(\n    (eve) => {\n      if (refresherRef.current !== PullingStatus.loading) {\n        setRefresherStatus(PullingStatus.loading);\n      }\n      const resetStatus = () => {\n        if (refresherRef.current !== PullingStatus.static) {\n          setTimeout(() => {\n            setRefresherStatus(PullingStatus.static);\n          }, refresherStayTime);\n        }\n      };\n      isFunction(onRefresh) &&\n        (onRefresh as Function)([\n          () => {\n            if (refresherRef.current === PullingStatus.loading) {\n              setRefresherStatus(PullingStatus.success);\n            }\n            resetStatus();\n          },\n          () => {\n            if (refresherRef.current === PullingStatus.loading) {\n              setRefresherStatus(PullingStatus.error);\n            }\n            resetStatus();\n          },\n        ]);\n      isFunction(onRefresherRefresh) && (onRefresherRefresh as Function)(eve);\n    },\n    [onRefresh, onRefresherRefresh, refresherStayTime, setRefresherStatus]\n  );\n\n  // 下拉刷新被终止\n  const _onRefresherAbort = useCallback(\n    (eve) => {\n      if (refresherRef.current !== PullingStatus.static) {\n        setRefresherStatus(PullingStatus.static);\n      }\n      isFunction(onRefresherAbort) && (onRefresherAbort as Function)(eve);\n    },\n    [onRefresherAbort, setRefresherStatus]\n  );\n\n  // 下拉刷新复位\n  const _onRefresherRestore = useCallback(\n    (eve) => {\n      if (refresherRef.current !== PullingStatus.static) {\n        debugger;\n        setRefresherStatus(PullingStatus.static);\n      }\n      isFunction(onRefreshCancel) && (onRefreshCancel as Function)();\n      isFunction(onRefresherRestore) && (onRefresherRestore as Function)(eve);\n    },\n    [onRefreshCancel, onRefresherRestore, setRefresherStatus]\n  );\n\n  // 滚动到底部\n  const onScrollToBottom = useCallback(\n    ({ force = false } = {}, eve) => {\n      if (!hasMore && (bottomState.loading || bottomState.error) && !force) {\n        return;\n      }\n      setBottomState({\n        loading: true,\n        error: false,\n      });\n      isFunction(onReachBottom) &&\n        (onReachBottom as Function)(\n          [\n            function stopLoading() {\n              setBottomState({\n                loading: false,\n                error: false,\n              });\n            },\n            function onError() {\n              setBottomState({\n                loading: false,\n                error: true,\n              });\n            },\n          ],\n          eve\n        );\n    },\n    [bottomState.error, bottomState.loading, onReachBottom, hasMore]\n  );\n\n  const bottomComponent = useMemo<React.ReactElement | null>(() => {\n    if (bottomState.loading) {\n      return isValidElement(loading) ? (\n        loading\n      ) : (\n        <Loading\n          block\n          size=\"40rpx\"\n          style={loadingStyle ?? {}}\n          className={`__list__loading__ ${loadingClass ?? \"\"}`}\n        >\n          {loadingText}\n        </Loading>\n      );\n    } else if (bottomState.error) {\n      return isValidElement(error) ? (\n        React.cloneElement(error, {\n          onClick: (eve) => {\n            error?.props?.onClick?.(eve);\n            onScrollToBottom({ force: true }, eve);\n          },\n        })\n      ) : (\n        <View\n          style={errorStyle}\n          className={`__list__error__ ${errorClass ?? \"\"}`}\n          onClick={(eve) => onScrollToBottom({ force: true }, eve)}\n        >\n          {errorText}\n        </View>\n      );\n    }\n    return null;\n  }, [\n    bottomState.loading,\n    bottomState.error,\n    loading,\n    loadingStyle,\n    loadingClass,\n    loadingText,\n    error,\n    errorStyle,\n    errorClass,\n    errorText,\n    onScrollToBottom,\n  ]);\n\n  return (\n    <ScrollView\n      {...restProps}\n      refresherThreshold={refresherThreshold}\n      onRefresherPulling={_onRefresherPulling}\n      onRefresherRefresh={_onRefresherRefresh}\n      onRefresherAbort={_onRefresherAbort}\n      onRefresherRestore={_onRefresherRestore}\n      refresherDefaultStyle={refresherDefaultStyle}\n      onScrollToLower={(eve) => onScrollToBottom(undefined, eve)}\n      refresherTriggered={refresherRef.current !== PullingStatus.static}\n      className={`__list__ ${className ?? \"\"}`}\n    >\n      {refresherDefaultStyle === \"none\" && (\n        <Slot name=\"refresher\">\n          <View\n            style={refresherStyle}\n            className={`__refresher__ ${refresherClassName ?? \"\"}`}\n          >\n            {pullStatusText[refresherRef.current]}\n          </View>\n        </Slot>\n      )}\n      {props?.children}\n      {!isEmpty(data) &&\n        isReactComponentType(ListComponent) &&\n        data?.map((_data, index) => (\n          // @ts-ignore\n          <ListComponent data={_data} key={_data?.id || index} />\n        ))}\n      {bottomComponent}\n    </ScrollView>\n  );\n};\n\nList.options = {\n  addGlobalClass: true,\n};\n\nexport default List;\n"],"names":[],"mappings":"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"}