{"version":3,"file":"index.js","sources":["../../../packages/utils/system/route.ts","../../../packages/utils/system/setting.ts","../../../packages/utils/system/index.ts"],"sourcesContent":["import {\n  Page,\n  getCurrentPages,\n  switchTab as _switchTab,\n  navigateTo as _navigateTo,\n  redirectTo as _redirectTo,\n  navigateBack as _navigateBack,\n  reLaunch as _reLaunch,\n} from \"@tarojs/taro\";\n\nconst AppConfig = {\n  pages: [],\n};\n\nconst promiseify = (fn: Function): any => (args = {}): Promise<any> =>\n  new Promise((resolve, reject) => {\n    fn({\n      ...args,\n      fail: reject,\n      success: resolve,\n    });\n  });\n\n/***************************** Page *************************************/\n\ndeclare type CurrentPage = {\n  pages: Page[];\n  current: Page;\n  isFirst: boolean;\n  isTabBar: boolean;\n  isRootPage: boolean;\n};\n/**\n *\n * 获取当前小程序页面信息\n * @returns {CurrentPage} 当前页面信息\n * pages 路由栈\n * current 当前路由页面\n * isFirst 路由栈长度为1\n * isRootPage 当前路由栈是否小程序tabBar页面\n *\n */\nexport const getCurrPages = (): CurrentPage => {\n  const pages = getCurrentPages();\n  const current = pages[pages.length - 1];\n  return {\n    pages,\n    current,\n    isTabBar: isTabBar(current),\n    isFirst: pages.length === 1,\n    isRootPage: isRootPage(current),\n  };\n};\n\n/**\n *\n * 判断页面是否为小程序tabBar页面\n *\n * @param {Page} page Page对象\n * @returns {boolean} Page是否为tabBar页面\n */\nexport const isTabBar = (page: Page): boolean => {\n  // @ts-ignore\n  const tabbarPages = AppConfig?.tabbar?.list ?? [];\n  return tabbarPages.some((_page) => _page?.pagePath === page.route);\n};\n\n/**\n *\n * @param {Page} page Page对象\n * @returns {boolean} Page是否为首页\n *\n */\nexport const isRootPage = (page: Page): boolean =>\n  AppConfig?.pages[0] === page.route;\n\n/****************************** Router ***********************************/\nconst promiseNavigateTo = promiseify(_navigateTo);\nconst promiseRedirectTo = promiseify(_redirectTo);\nconst promiseNavigateBack = promiseify(_navigateBack);\nconst promiseSwitchTab = promiseify(_switchTab);\nconst promiseRelaunch = promiseify(_reLaunch);\n\n/**\n * 跳转到指定小程序页面,如果路由栈大于9个,将关闭当前页面,并跳转到目的页面,返回Promise\n * @param {string} url 跳转页面路径\n * @param {General.IAnyObject} events 可选,页面间通信接口，用于监听被打开页面发送到当前页面的数据\n * @returns {Promise<any>} 返回Promise,成功then,失败catch\n *\n */\ndeclare type RouterOption = {\n  url: string;\n  events?: {\n    [key: string]: Function;\n  };\n};\nexport const navigateTo = (option: RouterOption): Promise<any> => {\n  const { pages } = getCurrPages();\n  return (pages.length >= 10 ? promiseRedirectTo : promiseNavigateTo)(option);\n};\n\n/**\n *\n * 关闭当前页面并跳转到目标页面,返回Promise\n * @param {string} url 跳转页面路径\n * @returns {Promise<any>} 返回Promise对象\n *\n */\nexport const redirectTo = (url: string): Promise<any> =>\n  promiseRedirectTo({ url });\n\n/**\n * 关闭当前页面,返回上一页面或多级页面\n * @param {number} delta 返回页面栈层数,默认1\n * @returns {Promise<any>} 返回Promise\n */\n\nexport const navigateBack = (delta: number = 1): Promise<any> =>\n  promiseNavigateBack({ delta });\n\n/**\n * 如果是tabBar页面将关闭所有非tabBar页面,否则关闭当前页面,跳转到目标页面\n * @param {string} url 跳转页面路径\n * @returns {Promise<any>} 返回Promise\n *\n */\nexport const switchTab = (url: string): Promise<any> => {\n  const _isTabBar = isRootPage({ route: url });\n  if (!_isTabBar) {\n    return redirectTo(url);\n  }\n  return promiseSwitchTab({ url });\n};\n\n/**\n * 关闭所有页面,打开对应页面\n * @param {string} url 打开页面地址\n * @returns {Promise<any>} 返回Promise\n *\n */\nexport const reLaunch = (url: string): Promise<any> => promiseRelaunch({ url });\n\n/**\n * 关闭所有页面,打开首页\n * @returns {Promise<any>} 返回Promise\n */\nexport const goToHome = (): Promise<any> => {\n  return reLaunch(`/${AppConfig.pages[0]}`);\n};\n","import { getSetting, authorize, showModal, openSetting } from \"@tarojs/taro\";\nimport { AuthScope } from \"types\";\n\n/**\n *\n * @param {AuthScope} scope 需要获取的授权项\n * @param {string} message 授权曾拒绝,提示打开设置页面的提示信息\n * @returns {Promise<any>} 返回 Promise<any>\n *\n */\n\nconst SCOPE_MESSAGE = {\n  userinfo: \"用户信息\",\n  userLocation: \"地理位置\",\n  userLocationBackground: \"后台定位\",\n  address: \"通讯地址\",\n  invoiceTitle: \"发票抬头\",\n  invoice: \"获取发票\",\n  werun: \"微信运动步数\",\n  record: \"录音功能\",\n  writePhotosAlbum: \"保存到相册\",\n  camera: \"摄像头\",\n};\n\nexport const ensureAuthScope = async (\n  scope: AuthScope,\n  message?: string\n): Promise<any> => {\n  const { authSetting } = await getSetting();\n  if (scope && authSetting[`scope.${scope}`] === true) {\n    return authSetting;\n  } else if (authSetting[`scope.${scope}`] === void 0) {\n    return await authorize({\n      scope: `scope.${scope}`,\n    });\n  }\n  return await showModal({\n    title: \"权限申请\",\n    content:\n      message ||\n      `检测到小程序已关闭${SCOPE_MESSAGE[scope] || \"相关\"}权限,是否前往打开?`,\n    confirmText: \"打开\",\n  })\n    .then((res) => {\n      if (res.confirm) {\n        return openSetting();\n      } else {\n        throw new Error(\"未授权,用户已取消!\");\n      }\n    })\n    .then((res) => {\n      const { authSetting: _auth } = res;\n      if (_auth && _auth[`scope.${scope}`]) {\n        return _auth;\n      } else {\n        throw new Error(\"用户未授权\");\n      }\n    });\n};\n","import {\n  getSystemInfoSync as _getSystemInfoSync,\n  getMenuButtonBoundingClientRect as _getMenuRect,\n} from \"@tarojs/taro\";\n\nexport * from \"./route\";\n\nexport * from \"./setting\";\n\n/**\n * 获取系统信息\n * @returns {Taro.getSystemInfoSync.Result} 当前设备系统信息\n */\nlet systemInfo: Taro.getSystemInfoSync.Result;\nexport const getSystemInfoSync = () => {\n  if (systemInfo == null) {\n    systemInfo = _getSystemInfoSync();\n  }\n  return systemInfo;\n};\n\n/**\n *\n * 获取菜单按钮的布局位置信息\n * @returns {Taro.getMenuButtonBoundingClientRect.Rect} 菜单按钮的布局位置信息\n */\nlet menuButtonRect: Taro.getMenuButtonBoundingClientRect.Rect;\nexport const getMenuButtonBoundingClientRect = () => {\n  if (menuButtonRect == null) {\n    menuButtonRect = _getMenuRect();\n  }\n  return menuButtonRect;\n};\n"],"names":["_navigateTo","_redirectTo","_navigateBack","_switchTab","_reLaunch","_getSystemInfoSync","_getMenuRect"],"mappings":"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"}